name: Syncing Tags

on:
  release:
    types:
      - published
      
permissions: 
  contents: write
  pull-requests: write

jobs:
  testing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: Finding SHA with latest Tag
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          COMMIT_SHA=$(git rev-list -n 1 $LATEST_TAG)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
      
      - name: Finding Branch with SHA
        run: |
          RELEASE_BRANCH=$(git branch -r --contains ${{ env.COMMIT_SHA }} | sed 's/origin\///' | sed 's/^[[:space:]]*//' | head -n1)
          echo "RELEASE_BRANCH=$RELEASE_BRANCH" >> $GITHUB_ENV

      - name: Create merge branch and merge release changes
        run: |
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            MERGE_BRANCH="merge-release-${{ env.LATEST_TAG }}"
            git checkout -b $MERGE_BRANCH
            
            git merge origin/${{ env.RELEASE_BRANCH }} --no-ff -m "Merge release ${{ env.LATEST_TAG }} from ${{ env.RELEASE_BRANCH }}"
            
            echo "MERGE_BRANCH=$MERGE_BRANCH" >> $GITHUB_ENV
            
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Sync release ${{ env.LATEST_TAG }} from ${{ env.RELEASE_BRANCH }} to main"
          title: "Merge Release ${{ env.LATEST_TAG }} to Main"
          body: |
            This PR merges release branch `${{ env.RELEASE_BRANCH }}` (tag: `${{ env.LATEST_TAG }}`) into `main`.
            
            **Release Details:**
            - Tag: `${{ env.LATEST_TAG }}`
            - Commit SHA: `${{ env.COMMIT_SHA }}`
            - Source Branch: `${{ env.RELEASE_BRANCH }}`
            
            **What's included:**
            - All commits from `${{ env.RELEASE_BRANCH }}`
            - All code changes from the release
            - Release notes and version updates
            
            This PR was automatically created after the release was published.
            
            ## Ready to merge!
            All release branch code will be merged into main when this PR is approved.
          branch: ${{ env.MERGE_BRANCH }}
          base: main
          delete-branch: true
name: Syncing Tags

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-release-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout all branches and tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Find latest tag and its branch
        id: find_branch
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          COMMIT_SHA=$(git rev-list -n 1 $LATEST_TAG)
          BRANCH=$(git branch -r --contains $COMMIT_SHA | grep -v 'HEAD' | grep -v 'main' | head -1 | sed 's|origin/||')
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.find_branch.outputs.branch }}
          title: "Release ${{ steps.find_branch.outputs.tag }} to main"
          base: main
          body: |
            Automated PR to merge branch `${{ steps.find_branch.outputs.branch }}` (tag: `${{ steps.find_branch.outputs.tag }}`) into `main`.
          draft: false

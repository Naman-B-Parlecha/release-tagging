name: Syncing Tags

on:
  release:
    types:
      - published
      
permissions: 
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Find release branch
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          COMMIT_SHA=$(git rev-list -n 1 $LATEST_TAG)
          RELEASE_BRANCH=$(git branch -r --contains $COMMIT_SHA | head -1 | sed 's/origin\///' | xargs)
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "RELEASE_BRANCH=$RELEASE_BRANCH" >> $GITHUB_ENV
      
      - name: Create PR using GitHub CLI
        run: |
          gh pr create \
            --title "Merge ${{ env.RELEASE_BRANCH }} into main - Release ${{ env.LATEST_TAG }}" \
            --body "Auto-generated PR to merge release ${{ env.LATEST_TAG }} into main" \
            --head "${{ env.RELEASE_BRANCH }}" \
            --base "main"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}